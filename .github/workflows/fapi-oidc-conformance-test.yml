# This workflow will test IS for OIDC conformance
# 

name: FAPI OIDC Conformance Test

on:
  # Allows the workflow to run automatically after a release
  release:
    types: [published]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      tag:
        description: 'product-is tag name'
        required: false
        default: 'v7.0.0-m1'
      download-url:
        description: 'URL to download product-is'
        required: false
      jwt-authenticator-tag:
        description: 'pvt-key-jwt-authenticator tag name'
        required: false
        default: 'v2.4.25'
      jwt-authenticator-download-url:
        description: 'URL to download pvt-key-jwt-authenticator jar'
        required: false
      conformance-suite-version:
        description: 'Conformance suite release tag in https://github.com/openid-certification/conformance-suite.git'
        required: false
        default: 'v5.1.1'
      resource-url:
        description: 'Resource url path'
        default: '/oauth2/userinfo'
      send-email:
        description: 'Send test results to email'
        required: false
        default: 'no'
      send-chat:
        description: 'Send test results to google chat'
        required: false
        default: 'no'

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        path: './product-is'
      
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11.0.18+10
    
    - name: Setup Python
      run: |
        python3 -m pip install --upgrade pip setuptools wheel
        pip3 install psutil
        pip3 install httpx
        pip3 install httplib2
        
    - name: Download IS zip
      run: |
        INPUT_URL=${{github.event.inputs.download-url}}
        INPUT_TAG=${{github.event.inputs.tag}}
        if [[ -z "${INPUT_URL}" ]] && [[ -z "${INPUT_TAG}" ]]; then
          echo "Either 'tag' or 'download-url' must be provided."
          exit 1
        fi
        if [[ -z "${INPUT_URL}" ]]; then
          owner="wso2"
          repo="product-is"
          if [[ -z "${INPUT_TAG}" ]]; then
            tag=${GITHUB_REF:10}
            tag_trimmed=${tag// }
          else
            tag=${{github.event.inputs.tag}}
            tag_trimmed=${tag// }
          fi

          artifact="wso2is-${tag_trimmed:1}.zip"
          echo "Tag=$tag"
          echo "Artifact=$artifact"
          list_asset_url="https://api.github.com/repos/${owner}/${repo}/releases/tags/${tag_trimmed}"
          asset_url=$(curl "${list_asset_url}" | jq ".assets[] | select(.name==\"${artifact}\") | .url" | sed 's/\"//g')
          curl -vLJO -H 'Accept: application/octet-stream' \
           "${asset_url}"
        else
          curl -vLJO -H 'Accept: application/octet-stream' \
           "${INPUT_URL}"
        fi

    - name: Download pvt key jwt authenticator & add configs to IS
      run: |
        JWT_AUTH_INPUT_URL=${{github.event.inputs.jwt-authenticator-download-url}}
        JWT_AUTH_INPUT_TAG=${{github.event.inputs.jwt-authenticator-tag}}
        
        echo "Downloading JWT Client Authenticator..."
        
        if [[ -z "${JWT_AUTH_INPUT_URL}" ]] && [[ -z "${JWT_AUTH_INPUT_TAG}" ]]; then
          echo "[JWT Client Authenticator] Either 'tag' or 'download-url' must be provided."
          exit 1
        fi
        if [[ -z "${JWT_AUTH_INPUT_URL}" ]]; then
          echo "[JWT Client Authenticator] No URL provided."
          owner="wso2-extensions"
          repo="identity-oauth-addons"
          
          if [[ -z "${JWT_AUTH_INPUT_TAG}" ]]; then
            echo "[JWT Client Authenticator] No Tag provided."
            tag=${GITHUB_REF:10}
            tag_trimmed=${tag// }
          else
            tag=${JWT_AUTH_INPUT_TAG}
            tag_trimmed=${tag// }
            echo "Tag = $tag_trimmed"
          fi
        
          artifact="org.wso2.carbon.identity.oauth2.token.handler.clientauth.jwt-${tag_trimmed:1}.jar"
          download_url="https://github.com/${owner}/${repo}/releases/download/${tag_trimmed}/${artifact}"
          
          echo "[JWT Client Authenticator] Artifact = $artifact"
          echo "[JWT Client Authenticator] Downloading via: ${download_url}"
  
          authenticator_file="$(curl -O --remote-name -s -w "%{filename_effective}" "${download_url}")"
          echo "[JWT Client Authenticator] $authenticator_file downloaded"
            
          if [[ -f "$artifact" ]]; then
            echo "[JWT Client Authenticator] $artifact downloaded."
          else
            echo "[JWT Client Authenticator] $artifact NOT Downloaded."
            exit 1
        fi
        
        else
          echo "[JWT Client Authenticator] Downloading via the provided url: ${JWT_AUTH_INPUT_URL}"
          authenticator_file="$(curl -O --remote-name -s -w "%{filename_effective}" "${JWT_AUTH_INPUT_URL}")"
          echo "[JWT Client Authenticator] $authenticator_file downloaded"
        fi
        
        # Move Downloaded JWT Client Authenticator to IS
        PRODUCT_IS_ZIP=$(find ./ -name 'wso2is*' -type f -printf "%f\n")
        echo "Unzipping Product IS: ${PRODUCT_IS_ZIP} ..."
        unzip -qq ${PRODUCT_IS_ZIP}
          
        PRODUCT_IS=$(find ./ -name 'wso2is*' -type d -printf "%f\n")
        echo "Directory Name: ${PRODUCT_IS}"
          
        MOVE_TO="${PRODUCT_IS}/repository/components/dropins"
        echo "Moving $authenticator_file to ${MOVE_TO}..."
        mv $authenticator_file $MOVE_TO
        
        # Add Client Authenticator configs to deployment.toml
        echo "Adding deployment-fapi-config.toml configs to deployment.toml..."
        echo "\n" >> ${PRODUCT_IS}/repository/conf/deployment.toml
        cat ./product-is/oidc-conformance-tests/fapi/config/deployment-fapi-config.toml >> ${PRODUCT_IS}/repository/conf/deployment.toml
        
        # zip IS back
        echo "Zipping $PRODUCT_IS to $PRODUCT_IS_ZIP"
        zip -qq -r $PRODUCT_IS_ZIP $PRODUCT_IS

    - name: Clone conformance suite
      run: |
        CONFORMANCE_SUITE_VERSION=${{github.event.inputs.conformance-suite-version}}
        git clone --depth 1 --branch release-${CONFORMANCE_SUITE_VERSION} https://github.com/openid-certification/conformance-suite.git
    
    - name: Adding extra hosts to docker-compose-dev.yml and adding iam as a localhost to /etc/hosts
      run: |
        sed -i '/^    volumes.*/i \ \ \ \ extra_hosts:\n \ \ \ \ - "localhost:\$IP\"\n \ \ \ \ - "iam:\$IP\"' ./conformance-suite/docker-compose-dev.yml
        sudo -- sh -c -e "echo '127.0.1.1 iam' >> /etc/hosts"

    - name: Run IS
      run: |
        PRODUCT_IS_ZIP=$(find ./ -name wso2is* -type f -printf "%f\n")
        cd ./product-is/oidc-conformance-tests
        python3 ./configure_is.py ../../$PRODUCT_IS_ZIP FAPI ${{secrets.FAPI_CLIENT1_JWKS}} ${{secrets.FAPI_CLIENT2_JWKS}} ${{secrets.FAPI_CLIENT1_MTLS}} ${{secrets.FAPI_CLIENT2_MTLS}} ${{github.event.inputs.resource-url}}
        
    - name: Run Conformance Suite
      run: |
        DOCKER_COMPOSE_FILE=./docker-compose-dev.yml
        cd conformance-suite
        IP=$(/sbin/ip -o -4 addr list eth0 | awk '{print $4}' | cut -d/ -f1)
        export IP
        echo "Host ip: " 
        printenv IP
        mvn clean package
        python3 ../product-is/oidc-conformance-tests/start_conformance_suite.py $DOCKER_COMPOSE_FILE
        
    - name: Run Tests
      run: bash ./product-is/oidc-conformance-tests/test_runner.sh FAPI
      
    - name: Test Results
      run: |
        IS_SUCCESSFUL=false
        if python3 ./product-is/oidc-conformance-tests/export_results.py https://localhost:8443
        then
          IS_SUCCESSFUL=true
        fi
        if $IS_SUCCESSFUL
        then
          echo "======================"
          echo "All Test Cases Passed!"
          echo "======================"
          exit 0
        else      
          echo "============================================="
          echo "Failed Test Cases Found. Exiting with Failure"
          echo "============================================="
          exit 1
        fi
      
    - name: Archive test results
      uses: actions/upload-artifact@v2
      if: always()
      with:
        name: test-results
        path: ./*test_results.zip
        
    - name: Archive test logs
      uses: actions/upload-artifact@v2
      if: always()
      with:
        name: test-logs
        path: ./*log.txt
    
    - name: Send Email
      if: always()
      run: |
        INPUT=${{github.event.inputs.send-email}}
        if [[ -z "${INPUT}" ]]; then
          INPUT="no"
        fi
        SEND_EMAIL=${INPUT^^}
        if [ $SEND_EMAIL == "YES" ]; then
          echo "============="
          echo "Sending Email"
          echo "============="
          CONFORMANCE_SUITE_URL=https://localhost:8443
          RESOURCE=${{github.event.inputs.download-url}}
          if [[ -z "${RESOURCE}" ]]; then
            RESOURCE=${{github.event.inputs.tag}}
          fi
          python3 ./product-is/oidc-conformance-tests/send_email.py $CONFORMANCE_SUITE_URL $GITHUB_RUN_NUMBER ${{job.status}} ${{github.repository}} ${{github.run_id}} ${{secrets.SENDER_EMAIL}} ${{secrets.PASSWORD}} ${{secrets.RECEIVER_LIST}} $RESOURCE
        elif [ $SEND_EMAIL == "NO" ]; then
          echo "========================================"
          echo "Skipped Sending Email"
          echo "========================================"
        else
          echo "================================================================="
          echo "Invalid parameter value. Skipped sending email"
          echo "================================================================="
        fi
        
    - name: Send Chat message
      if: always()
      run: |
        INPUT=${{github.event.inputs.send-chat}}
        RESOURCE=${{github.event.inputs.download-url}}
        if [[ -z "${RESOURCE}" ]]; then
          RESOURCE=${{github.event.inputs.tag}}
        fi
        if [[ -z "${INPUT}" ]]; then
          INPUT="yes"
        fi
        SEND_CHAT=${INPUT^^}
        if [ $SEND_CHAT == "YES" ]; then
          echo "==========================="
          echo "Sending Google Chat Message"
          echo "==========================="
          CONFORMANCE_SUITE_URL=https://localhost:8443
          python3 ./product-is/oidc-conformance-tests/send_chat.py "$CONFORMANCE_SUITE_URL" "$GITHUB_RUN_NUMBER" "${{job.status}}" "${{github.repository}}" "${{github.run_id}}" "${{secrets.GOOGLE_CHAT_WEBHOOK_OIDC_TEST}}" "$RESOURCE"
        elif [ $SEND_CHAT == "NO" ]; then
          echo "========================================"
          echo "Skipped Sending Google Chat Message"
          echo "========================================"
        else
          echo "================================================================="
          echo "Invalid parameter value. Skipped sending google chat message"
          echo "================================================================="
        fi
       
   
    

